angular.module('well', [
  'ngRoute',
  'firebase',
  'well.controllers',
  'well.filters',
  'well.services',
  'well.directives'
])
.config(function ($routeProvider, $locationProvider) {
  $routeProvider
    .when('/', {
      templateUrl: 'landing.html'
    })
    .when('/login', {
      templateUrl: 'login.html'
    })
    .when('/signup', {
      templateUrl: 'signup.html'
    })
    .when('/survey', {
      templateUrl: 'survey.html',
      controller: 'SurveyCtrl'
    })
    .when('/tradeoff', {
      templateUrl: 'tradeoff.html',
      controller: 'TradeOffCtrl'
    })
    .when('/history', {
      templateUrl: 'history.html',
      controller: 'HistoryCtrl'
    })
    .when('/test/:num', {
      templateUrl: 'history.html',
      controller: 'TestCtrl'
    })
    .when('/color', {
      templateUrl: 'color.html',
    })
    .otherwise({
      redirectTo: '/'
    })

  // $locationProvider.html5Mode(true)
})

/* Services */

angular.module('well.services', [])
  .factory('User', function ($q, $rootScope, $firebaseSimpleLogin, $firebase) {
    var deferred = $q.defer()
    var auth = $firebaseSimpleLogin(new Firebase('https://well.firebaseio.com/')),
      history

    $rootScope.$on('$firebaseSimpleLogin:login', function(e, user) {
      console.log('User ' + user.id + ' successfully logged in!')
      history = $firebase(new Firebase('https://well.firebaseio.com/' + user.md5_hash))
      history.$on('loaded', function (values) {
        deferred.resolve()
      })
    })

    return {
      login: function (email, password) {
        return auth.$login('password', {
          email: email,
          password: password,
          rememberMe: true
        })
      },
      signup: function (email, password) {
        return auth.$createUser(email, password)
      },
      logout: function () {
        auth.$logout()
      },
      promise: function () {
        return deferred.promise
      },
      info: function () {
        return auth.user
      },
      history: function () {
        return history
      },
      record: function (data) {
        return history.$add(data)
      }
    }
  })
  .factory('Aspects', function () {
    var names = ['Health', 'Happiness', 'Freedom', 'Financial Security', 'Meaning & Value']
    var texts = {
      'Health': 'Your health (physical and mental)', 
      'Happiness': 'Your overall happiness', 
      'Freedom': 'Your freedom (political, religious, civil, of movement, of speech, etc.)', 
      'Financial Security': 'Your financial security', 
      'Meaning & Value': 'Your sense that your life is meaningful and has value'
    }
    return {
      names: function () {
        return names
      },
      texts: function () {
        return texts
      },
      getColor: function (aspect, level) {
        var h = (names.indexOf(aspect) + 6) * 70,
            l =  .99 + (level / 100) * -.24
        return d3.hsl(h, .8, l).toString()
      },
      mixColor: function (a1, a2, pref) {
        var p = (pref - 5) / 5
            h = p * ( (names.indexOf(a2) + 6) * 70 ) - p * ( (names.indexOf(a1) + 6) * 70 )
        return d3.hsl(h, .8, .8).toString()
      }
    }
  })
  .factory('Survey', function (Aspects) {
    var aspects = Aspects.names(),
      responses = {}
    for (var i in aspects) {
      responses[aspects[i]] = {}
      responses[aspects[i]].level = null
    }
    return {
      responses: function () {
        return responses
      },
      respond: function (aspect, level) {
        responses[aspect].level = level
      },
      responded: function () {
        return aspects.every(function (a) {
          return responses[a].level
        })
      },
      randomize: function () {
        for (var i in aspects) {
          responses[aspects[i]].level = Math.ceil(Math.random() * 100)
        }
      }
    }
  })
  .factory('TradeOff', function (Aspects, Survey, User, $location) {
    var aspects = Aspects.names(),
      responses = Survey.responses(),
              n = 0,
              i = 1,
           left = JSON.parse(JSON.stringify(responses)),
          right = JSON.parse(JSON.stringify(responses)),
              a = left[aspects[n]],
              b = right[aspects[i]],
        choices = []

    function record (p) {
      choices.push({
        a: n,
        b: i,
        a_d: a.diff,
        b_d: b.diff,
        p: p,
        t: Date.now()
      })
    }

    function gcd (n, d) {
      if (d) {
        return gcd (d, n % d)
      } else {
        return Math.abs(n)
      }
    }

    function simplify (f) {
      var div = gcd(f[0], f[1])
      return [f[0] / div, f[1] / div]
    }

    function median (f1, f2) {
      var f = []
      f[0] = f1[0] * f2[1] + f2[0] * f1[1]
      f[1] = f1[1] * f2[1] * 2
      return simplify(f)
    }

    for (var k in responses) {
      responses[k].lower = null
      responses[k].upper = null
    }
    responses[aspects[n]].lower = [1, 1]
    responses[aspects[n]].upper = [1, 1]

    var service = {
      left: function () {
        return left
      },
      right: function () {
        return right
      },
      responses: function () {
        return responses
      },
      choose: function (p) {
        this.init(p)
      },
      choice: function () {
        return {
          numeraire: {
            name: aspects[n],
            diff: left[aspects[n]].diff
          },
          comparison: {
            name: aspects[i],
            diff: right[aspects[i]].diff
          }
        }
      },
      loadChoice: function () {
        if (!Survey.responded()) Survey.randomize()
        responses = Survey.responses()

        a = left[aspects[n]],
        b = right[aspects[i]]

        a.diff = b.diff = (100 - a.level > 4 && 100 - b.level > 4) ? 5 : Math.min(100 - a.level, 100 - b.level)
        
        this.choose = this.init
        return [left, right]
      },
      init: function (p) {
        record(p)
        if (p < 0) {
          responses[aspects[i]].upper = [1, 1]
          if (a.diff === 1) {
            responses[aspects[i]].lower = [0, 1]
            this.next()
          } else {
            a.diff = 1
            this.choose = function (p) {
              record(p)
              if (p < 0) {
                responses[aspects[i]].upper = simplify([1, b.diff])
                this.halve()
              } else {
                responses[aspects[i]].lower = simplify([1, b.diff])
                this.hone()
              }
              return [left, right]
            }
          }
        } else {
          responses[aspects[i]].lower = [1, 1]
          if (a.diff === 1) {
            responses[aspects[i]].upper = [1, 0]
            this.next()
          } else {
            b.diff = 1
            this.choose = function (p) {
              record(p)
              if (p < 0) {
                responses[aspects[i]].upper = simplify([a.diff, b.diff])
                this.hone()
              } else {
                responses[aspects[i]].lower = simplify([a.diff, b.diff])
                this.twice()
              }
              return [left, right]
            }
          }
        }
        return [left, right]
      },
      halve: function () {
        if (b.diff * 2 > 100 - b.level) {
          this.next()
        } else {
          b.diff *= 2
          this.choose = function (p) {
            record(p)
            if (p < 0) {
              responses[aspects[i]].upper = simplify([a.diff, b.diff])
              this.halve()
            } else {
              responses[aspects[i]].lower = simplify([a.diff, b.diff])
              this.next()
            }
            return [left, right]
          }
        }
      },
      twice: function () {
        if (a.diff * 2 > 100 - a.level) {
          next()
        } else {
          a.diff *= a
          this.choose = function (p) {
            record(p)
            if (p < 0) {
              responses[aspects[i]].upper = simplify([a, b])
              this.next()
            } else {
              responses[aspects[i]].lower = simplify([a, b])
              this.twice()
            }
            return [left, right]
          }
        }
      },
      hone: function () {
        var u = responses[aspects[i]].upper,
            l = responses[aspects[i]].lower,
           ab = median(l, u)

        ab[0] = Math.round(5 * ab[0] / ab[1])
        ab[1] = 5
        console.log(ab)

        if (simplify(ab)[0] === u[0] || simplify(ab)[0] === l[0]) {
          console.log('eh')
          this.next()
        } else {
          a.diff = ab[0]
          b.diff = ab[1]
          this.choose = function (p) {
            record(p)
            if (p < 0) {
              responses[aspects[i]].upper = ab
            } else {
              responses[aspects[i]].lower = ab
            }
            this.hone()
            return [left, right]
          }
        }
      },
      next: function () {
        b.diff = 0
        i += 1
        if (i === aspects.length) {
          this.finish()
        } else {
          this.loadChoice()
        }
      },
      finish: function () {
        User.record({
          aspects: aspects,
          responses: responses,
          choices: choices,
          date: Date.now()
        }).then(function () {
          $location.path('/history')
        })
      }
    }
    return service
  })
  .factory('Style', function($window) {
    var sheet = (function() {
      var style = document.createElement('style')

      // Add a media (and/or media query) here if you'd like!
      // style.setAttribute("media", "screen")
      // style.setAttribute("media", "@media only screen and (max-width : 1024px)")

      // WebKit hack :(
      style.appendChild(document.createTextNode(''))

      document.head.appendChild(style)

      return style.sheet
    })()

    return function (selector, rules, index) {
      if (sheet.insertRule) {
        sheet.insertRule(selector + "{" + rules + "}", index);
      } else {
        sheet.addRule(selector, rules, index);
      }
    }
  })
/* Controllers */

angular.module('well.controllers', [])
  .controller('AppCtrl', function ($scope, User, $location) {

    $scope.splash = {
      url: 'welcome.html'
    }

    $scope.user = User

    $scope.login = {
      submit: function() {
        User.login(this.email, this.password).then(function(user) {
          console.log('Logged in as: ', user.uid);
          $location.path('/survey')
        }, function(error) {
          console.error('Login failed: ', error);
        })
      }
    }

    $scope.signup = {
      submit: function() {
        User.signup(this.email, this.password)
        .then(function(user) {
          console.log('Logged in as: ', user.uid);
          $location.path('/survey')
        }, function(error) {
          console.error('Login failed: ', error);
        })
      }
    }

    $scope.settings = {
      devmode: false
    }

    $scope.colors = d3.range(5).map(function(d) { return d3.hsl((d + 0) * 70, 1, .8).toString() })
    $scope.color = [
      '#ffff99',
      '#99ffaa',
      '#99ddff',
      '#cc99ff',
      '#ff99bb',
    ]
  })
  .controller('SurveyCtrl', function ($scope, Aspects, Survey, Style, $location) {
    $scope.aspects = Aspects.names()

    $scope.loadTradeOff = function () {
      if (Survey.responded()) {
        $location.path('tradeoff')
        window.scrollTo(0, 0)
      } else {
        Style('.unfilled', 'border: 1px solid rgb(255,200,200)')
      }
    }
  })
  .controller('TradeOffCtrl', function ($scope, Aspects, TradeOff) {
    $scope.aspects = Aspects.names()

    $scope.responses = TradeOff.responses()
    var choice = TradeOff.loadChoice()
    $scope.left = choice[0]
    $scope.right = choice[1]

    $scope.choice = TradeOff.choice()
    $scope.$watch('left', function () {
      $scope.choice = TradeOff.choice()
    }, true)
    $scope.$watch('right', function () {
      $scope.choice = TradeOff.choice()
    }, true)

    $scope.choose = function (p) {
      choice = TradeOff.choose(p)
      $scope.left = choice[0]
      $scope.right = choice[1]

      var neu = d3.select('.options').style('opacity', '0')
      var w = neu.style('width')

      var old = neu.select(function() { return this.parentNode.insertBefore(this.cloneNode(true), this) })
          .style('opacity', '1')


      old.transition()
          .duration(1000)
          .style('left', '-' + w)
          .style('opacity', '0')
          .each('end', function () {
            old.remove()
          })

      neu.transition()
          .duration(1000)
          .style('left', '-' + w)
          .style('opacity', '1')
          .each('end', function () {
            neu.style('left', '0px')
          })
    }

    $scope.prefs = {
      degree: null,
      range: [null, -5, -4, -3, -2, -1, 1, 2, 3, 4, 5],
      next: function () {
        console.log(this.degree)
        $scope.choose(this.degree)
        this.degree = 0
      }
    }
  })
  .controller('HistoryCtrl', function ($scope, User) {
    $scope.data = null
    User.promise().then(function () {
      var history = User.history()
      var keys = history.$getIndex()
      var data = [], weights = []
      for (var i in keys) {
        var responses = history[keys[i]].responses
        var aspects = history[keys[i]].aspects
        var datum = {
          date: history[keys[i]].date
        }
        aspects.forEach(function (a) {
          var weight = 1
          if (responses[a].lower && responses[a].upper) {
            weight = (responses[a].lower[0] * responses[a].upper[1] + responses[a].lower[1] * responses[a].upper[0]) / (responses[a].lower[1] * responses[a].upper[1] * 2)
          } 
          datum[a] = {
            value: responses[a].level,
            weight: weight
          }
          if (weights[a]) {
            weights[a] += weight
          } else {
            weights[a] = weight
          }
        })
        data.push(datum)
      }

      var sum = 0
      for (var a in weights) {
        sum += weights[a]
      }
      for (var a in weights) {
        weights[a] /= sum
      }
      data.forEach(function (e) {
        for (var a in e) {
          e[a].weight = weights[a]
        }
      })
      $scope.data = data
    })
  })
  .controller('TestCtrl', function ($scope, $routeParams) {
    var data = []
    for (var i = 0; i < Number($routeParams.num); i += 1) {
      var date = (new Date('January 1 2012')).getTime() + Math.round(30 * (i + Math.random())) * 86400000
      data.push({
        'Health': {
          value: Math.round(Math.max(Math.random() * 100, Math.random() * 100))
        },
        'Happiness': {
          value: Math.round(Math.max(Math.random() * 100, Math.random() * 100))
        },
        'Freedom': {
          value: Math.round(Math.max(Math.random() * 100, Math.random() * 100))
        },
        'Financial Security': {
          value: Math.round(Math.max(Math.random() * 100, Math.random() * 100))
        },
        'Meaning/Value': {
          value: Math.round(Math.max(Math.random() * 100, Math.random() * 100))
        },
        date: date
      })
    }
    console.log(data)
    var logNormal = d3.random.logNormal()

    var weights = [1, logNormal(), logNormal(), logNormal(), logNormal()]
    var w_sum = weights.reduce(function (a, b) {
      return a + b
    })
    weights = weights.map(function (d) {
      return d / w_sum
    })

    var w = {
      'Health': weights[0],
      'Happiness': weights[1],
      'Freedom': weights[2],
      'Financial Security': weights[3],
      'Meaning/Value': weights[4]
    }

    var weights = d3.range(data.length).map(function () {
      return w
    })

    var labelVar = 'date'
    var varNames = d3.keys(data[0])
      .filter(function (key) { return key !== labelVar;});

    data.forEach(function (e, i, a) {
      varNames.forEach(function (name) {
        e[name].weight = weights[i][name]
      })
    })

  $scope.data = data
  })
/* Filters */

angular.module('well.filters', []).
  filter('interpolate', function (version) {
    return function (text) {
      return String(text).replace(/\%VERSION\%/mg, version);
    };
  });

/* Directives */

angular.module('well.directives', [])
  .directive('slider', function($window, $timeout, Aspects, Survey, TradeOff) {
    return {
      restrict: 'EA',
      scope: {
        fixed: '@'
      },
      template: '<h5><span>{{ text }}:</span><span class="pull-right">{{ level + diff }}</span></h5><div class="svg" ng-class="{ unfilled: level === null }"></div>',
      link: function(scope, element, attrs) {
        attrs.$observe('name', function (name) {
          scope.text = Aspects.texts()[name]
          scope.level = Survey.responses()[name].level
          scope.name = name
        })

        attrs.$observe('diff', function (diff) {
          if (diff) {
            scope.diff = Number(diff)
          }
          scope.render()
        })

        var svg = d3.select(element[0].children[1])
          .append('svg')
          .style('width', '100%')
          .style('padding','0.1px 8px 16px 8px')

        window.onresize = function() {
          scope.$apply()
        }

        scope.$watch(function() {
          return angular.element($window)[0].innerWidth
        }, function() {
          scope.render()
        })

        var clicked = false

        scope.render = function () {
          svg.selectAll('*').remove()

          var margin = {top: 0, right: 20, bottom: 0, left: 10},
              width = d3.select(element[0])[0][0].offsetWidth - svg.style('padding-left').split('px')[0] - svg.style('padding-right').split('px')[0],
              height = scope.fixed ? 20 : 50

          var x = d3.scale.linear()
              .domain([0, 100])
              .range([0, width])
              .clamp(true)

          var brush = d3.svg.brush()
              .x(x)
              .extent([scope.level, scope.level])

          svg
              .attr('width', width)
              .attr('height', height)

          var axis = svg.append('g')
              .attr('class', 'axis')
              .attr('transform', 'translate(0,' + (height - 10) + ')')

          // axis.append('text')
          //     .text(1)
          //     .attr('x', x(1))
          //     .attr('y', 12)
          //     .attr('dy', '.71em')
          //     .style('text-anchor', 'middle')


          axis.call(d3.svg.axis()
              .scale(x)
              .orient('bottom')
              .tickSize(0)
              .tickPadding(12))
          
          var domain = axis.select('.domain')
              .attr('transform', 'translate(0,' + (- height + 20) + ')')

          if (!scope.fixed) {
            domain.select(function() { return this.parentNode.appendChild(this.cloneNode(true)); })
              .attr('class', 'halo')
          } else {
            domain.remove()
          }

          var slider = svg.append('g')
              .attr('class', 'slider')
              .call(brush)

          slider.selectAll('.extent,.resize')
              .remove()

          slider.select('.background')
              .attr('height', height)

          var barBack = svg.append('rect')
              .attr('y', (height - 26))
              .attr('height', 20)
              .attr('width', x(100))
              .style('fill', Aspects.getColor(scope.name, 10))

          var bar = svg.append('rect')
              .attr('y', (height - 26))
              .attr('height', 20)
              .attr('width', 0)
              .style('fill', Aspects.getColor(scope.name, 100))

          var rect = svg.append('rect')
              .attr('y', (height - 26))
              .attr('height', 20)
              .attr('width', 0)
              .style('fill', Aspects.getColor(scope.name, 205))

          var text = svg.append('text')
              .attr('dy', 11)
              .style('fill', '#000')
              .style('font-weight', '400')

          var pointy = function () {
            var cx = x(1),
              cy = 10
            return {
              set: function (pt) {
                cx = pt
                return [
                  { x: cx - 6, y: cy - 6 },
                  { x: cx + 6, y: cy - 6 },
                  { x: cx + 6, y: cy + 6 },
                  { x: cx, y: cy + 10 },
                  { x: cx - 6, y: cy + 6 }
                ]
              }

            }
          }

          var line = d3.svg.line()
            .x(function (d) { return d.x })
            .y(function (d) { return d.y })

          if (!scope.fixed) {
            var handle = slider.append('path')
              .attr('class', 'handle')
              .attr('d', line(pointy().set(x(10))) + 'Z')
          }

          slider
              .call(brush.event)
            .transition() // gratuitous intro!
              .duration(250)
              .call(brush.extent([scope.level, scope.level]))
              // .call(brush.event)

          var target = svg.append('rect')
              .attr('class', 'target')
              .attr('width', width)
              .attr('height', 40)
              .attr('transform', 'translate(0,-20)')
              .style('fill-opacity', '0')
              .style('cursor', 'ew-resize')
              .on('mousemove', brushed)
              .on('click', brushed)

          function brushed() {
            console.log(x.invert(d3.mouse(this)[0]), d3.event.type, clicked)
            var value = brush.extent()[0]

            if (d3.event.type === 'click') {
              if (!clicked)  {
                target.style('cursor', 'pointer')
              } else {
                target.style('cursor', 'ew-resize')
              }
              clicked = !clicked
            }

            if (d3.event.type === 'click' || !clicked) {
              var v = x.invert(d3.mouse(this)[0])
              value = isNaN(v) ? value : v
              brush.extent([value, value])
            }

            if (value) value = Math.round(value)

            handle.attr('d', line( pointy().set( x(value) ) ) + 'Z')
            bar.attr('width', x(value))

            $timeout(function () {
              scope.level = value
              Survey.respond(scope.name, scope.level)
            })

          }

          if (scope.diff && scope.level) {
            bar.attr('width', x(scope.level))
            rect
                .attr('x', x(scope.level))
              .transition()
                .duration(250)
                .attr('width', x(scope.diff))

            text.text('+' + scope.diff)

            text
              .attr('x', x(scope.level) + x(scope.diff))
              .attr('dx',  4)
          } else if (scope.level) {
            bar.attr('width', x(scope.level))

            text
              .attr('x', x(scope.level))
              .attr('dx',  4)
          }
        }
      }
    }
  })
  .directive('earth', function ($location) {
    return {
      restrict: 'A',
      link: function (scope, element, attrs) {
        var splash = d3.select('.splash')

        var width = splash.style('width').replace('px',''),
            height = splash.style('height').replace('px','');

        var velocity = 0.03,
            t0 = Date.now();

        var projection = d3.geo.orthographic()
            .precision(0)
            .scale(600)
            .translate([width / 2, height / 2]);

        var canvas = d3.select('.earth').append("canvas")
            .attr("width", width)
            .attr("height", height);

        var context = canvas.node().getContext("2d");

        var path = d3.geo.path()
            .projection(projection)
            .context(context);

        d3.json("world-110m.json", function(error, world) {
          var land = topojson.feature(world, world.objects.land);
          var countries = topojson.feature(world, world.objects.countries).features

          for (var i in countries) {
            countries[i].properties.color = Math.random() * 100
          }

          d3.timer(function() {
            var t = Date.now() - t0;
            projection.rotate([velocity * t * .1, 0, 30]);
            context.clearRect(0, 0, width, height);
            // context.beginPath();
            // context.strokeStyle = '#766951'
            // path(land);
            // context.stroke()

            for (var i in countries) {
              context.beginPath()
              context.strokeStyle = d3.hsl(++countries[i].properties.color, .8, .8).toString()
              path(countries[i])
              context.stroke()
            }
            if ($location.path() !== '/') return true
          });
        });
      }
    }
  }).
  directive('plot', function ($window, Aspects) {
    return {
      restrict: 'EA',
      scope: {
        data: '=',
        weighted: '&'
      },
      link: function (scope, element, attrs) {
        var svg = d3.select(element[0]).append('svg')
            .style('width', '100%')
            .style('height', '500px')
            .style('padding', '20px')
          .append('g')


        window.onresize = function() {
          scope.$apply()
        }

        scope.$watch(function() {
          return angular.element($window)[0].innerWidth
        }, function() {
          if (scope.data) scope.render(data)
        })

        scope.$watch('data', function (data) {
          var d = scope.data
          if (d) scope.render(d)
        }, true)

        var percent = d3.format('%')

        var single = function () {
          data.push(JSON.parse(JSON.stringify(data[0])))
          data[0].date = 0
          svg.selectAll('*').remove()

          var margin = {top: 0, right: 0, bottom: 0, left: 0},
              // width = d3.select(element[0])[0][0].offsetWidth - svg.style('padding-left').split('px')[0] - svg.style('padding-right').split('px')[0],
              width = d3.select('svg').style('width').replace('px','') - 40,
              height = 500

          var x = d3.time.scale()
              .domain([data[0].date, data[data.length - 1].date])
              .rangeRound([120, width]);

          var y = d3.scale.linear()
              .rangeRound([height - 40, 0]);

          var stack = d3.layout.stack()
              .offset('zero')
              .values(function (d) { return d.values })
              .order('reverse')
              .x(function (d) { return x(d.label) })
              .y(function (d) { return d.weight * d.value });

          var area = d3.svg.area()
              .x(function (d) { return x(d.label) })
              .y0(function (d) { return y(d.y0); })
              .y1(function (d) { return y(d.y0 + d.y); });

          var color = d3.scale.ordinal()
              .range(d3.range(5).map(function(d) { return d3.hsl((d + 1) * 70,.8,.8).toString() }));

          color.domain(varNames);

          var seriesArr = [], series = {};
          varNames.forEach(function (name) {
            series[name] = {name: name, values:[]}
            seriesArr.push(series[name]);
          });

          data.forEach(function (d) {
            varNames.map(function (name) {
              series[name].values.push({label: d[labelVar], value: +d[name].value, weight: +d[name].weight  });
            });
          });

          stack(seriesArr);

          y.domain([0, d3.max(seriesArr, function (c) { 
              return d3.max(c.values, function (d) { return d.y0 + d.y; });
            })]);

          var selection = svg.selectAll(".series")
            .data(seriesArr)
            .enter().append("g")
              .attr("class", "series");

          selection.append("path")
            .attr("d", function (d) { return area(d.values); })
            .style("fill", function (d) { return Aspects.getColor(d.name, 99); })
            // .style('fill-opacity', '0.3')
            .style("stroke", '#fff');

          svg.append('text')
            .text('Well-Being Index')
            .attr('text-anchor', 'end')
            .attr('x', function (d) { return x(seriesArr[0].values[0].label) })
            .attr('y', height)
            .attr('dy', -16)
            .attr('dx', -10)
            .style('font-weight', 'bold')
            .style('text-decoration', 'underline')

          svg.append('text')
            .text(function () {
              var sum = 0
              for (var i in varNames) {
                sum += data[0][varNames[i]].value * data[0][varNames[i]].weight
              }
              return Math.round(sum)
            })
            .attr('text-anchor', 'start')
            .attr('x', function (d) { return x(seriesArr[0].values[0].label) })
            .attr('y', height)
            .attr('dx', 10)
            .attr('dy', -16)
            .style('font-weight', 'bold')
            .style('text-decoration', 'underline')

          svg.selectAll('.label')
            .data(seriesArr)
            .enter().append('text')
              .text(function (d) { return d.name })
              .style('font-weight', 'bold')
              .attr('text-anchor', 'end')
              .attr('x', function (d) { return x(d.values[0].label) })
              .attr('dx', -10)
              .attr('y', function (d) { return y(d.values[0].y0 + (d.values[0].y / 2) ) })

           svg.selectAll('.weight')
            .data(seriesArr)
            .enter().append('text')
              .text(function (d) { return percent(d.values[0].weight) })
              .attr('text-anchor', 'end')
              .attr('x', function (d) { return x(d.values[0].label) })
              .attr('dx', -10)
              .attr('y', function (d) { return y(d.values[0].y0 + (d.values[0].y / 2) ) })
              .attr('dy', '1em')

          svg.selectAll('.value')
            .data(seriesArr)
            .enter().append('text')
              .text(function (d) { return d.values[0].value })
              .attr('class', 'value')
              .attr('text-anchor', 'start')
              .attr('x', function (d) { return x(d.values[0].label) })
              .attr('dx', 10)
              .attr('y', function (d) { return y(d.values[0].y0 + (d.values[0].y / 2) ) })
        }

        var multi = function () {
          var duration = data[data.length - 1].date - data[0].date
          data.unshift(JSON.parse(JSON.stringify(data[0])))
          data.push(JSON.parse(JSON.stringify(data[data.length - 1])))
          data[0].date = data[0].date - duration * 0.03
          data[data.length - 1].date = data[data.length - 1].date + duration * 0.03
          svg.selectAll('*').remove()

          var margin = {top: 0, right: 0, bottom: 0, left: 0},
              // width = d3.select(element[0])[0][0].offsetWidth - svg.style('padding-left').split('px')[0] - svg.style('padding-right').split('px')[0],
              width = d3.select('svg').style('width').replace('px','') - 60,
              height = 500

          var dates = data.map(function (d) {
            return d.date
          })

          var x = d3.time.scale()
              .domain([dates[0], dates[data.length - 1]])
              .rangeRound([120, width]);

          var y = d3.scale.linear()
              .rangeRound([height - ((varNames.length ) * (varNames.length - 1) * 2.5), 20]);

          var stack = d3.layout.stack()
              .offset('zero')
              .values(function (d) { return d.values; })
              .order('reverse')
              .x(function (d) { return x(d.label) })
              .y(function (d) { return d.weight * d.value });

          var area = d3.svg.area()
              .interpolate('monotone')
              .x(function (d) { return x(d.label) })
              .y0(function (d) { return y(d.y0) + varNames.indexOf(d.name) * 2 })
              .y1(function (d) { return y(d.y0 + d.y) + varNames.indexOf(d.name) * 2 });

          var color = d3.scale.ordinal()
              .range(d3.range(5).map(function(d) { return d3.hsl((d + 1) * 70,.8,.8).toString() }));

          color.domain(varNames);

          var seriesArr = [], series = {};
          varNames.forEach(function (name) {
            series[name] = {name: name, values:[]};
            seriesArr.push(series[name]);
          });

          data.forEach(function (d) {
            varNames.map(function (name) {
              series[name].values.push({label: d[labelVar], value: +d[name].value, weight: +d[name].weight, name: name });
            });
          });

          stack(seriesArr);
          console.log(seriesArr)

          maxY = d3.max(seriesArr, function (c) { 
            return d3.max(c.values, function (d) { return d.y0 + d.y; });
          })
          y.domain([0, maxY]);

          var back = svg.selectAll()
            .data(seriesArr)
            .enter().append('g')

          back.append("path")
            .attr('id', function (d) { return d.name })
            .attr("d", function (d) { return area(d.values) })
            .style("fill", function (d) { return Aspects.getColor(d.name, 99) })
            .style("stroke", '#fff')

          svg.selectAll().data(seriesArr)
            .enter().append('text')
              .text(function (d) { return d.name })
              .style('font-weight', 'bold')
              .attr('text-anchor', 'end')
              .attr('x', function (d) { return x(d.values[0].label) })
              .attr('dx', -10)
              .attr('y', function (d) { return y(d.values[0].y0 + (d.values[0].y / 2) ) + varNames.indexOf(d.name) * 2  })

          svg.selectAll().data(seriesArr)
            .enter().append('text')
              .text(function (d) { return percent(d.values[0].weight) })
              .attr('text-anchor', 'end')
              .attr('x', function (d) { return x(d.values[0].label) })
              .attr('dx', -10)
              .attr('y', function (d) { return y(d.values[0].y0 + (d.values[0].y / 2) ) + varNames.indexOf(d.name) * 2  })
              .attr('dy', '1em')

          var selection = svg.selectAll(".series")
            .data(seriesArr)
            .enter().append("g")
              .attr("class", "series");

          selection.append("path")
            .attr("class", "streamPath")
            .attr('id', function (d) { return d.name })
            .attr("d", function (d) { return area(d.values) })
            .style('fill', function (d) { return Aspects.getColor(d.name, 60) })

          // selection.append('rect')
          //   .attr('x', function (d) { return -100 })
          //   .attr('y', function (d) { return y(d.values[0].y0 + d.values[0].y) + varNames.indexOf(d.name) * 2 })
          //   .attr('height', function (d) { return y(d.values[0].y0) - y(d.values[0].y0 + d.values[0].y) })
          //   .attr('width', function (d) { return x(d.values[0].label) + 100 })
          //   .style('fill', function (d) { return Aspects.getColor(d.name, 60) })

          // selection.append('rect')
          //   .attr('x', function (d) { return x(d.values[d.values.length - 1].label) })
          //   .attr('y', function (d) { return y(d.values[d.values.length - 1].y0 + d.values[d.values.length - 1].y) + varNames.indexOf(d.name) * 2  })
          //   .attr('width', 40)
          //   .attr('height', function (d) { return y(d.values[d.values.length - 1].y0) - y(d.values[d.values.length - 1].y0 + d.values[d.values.length - 1].y) })
          //   .style('fill', function (d) { return Aspects.getColor(d.name, 60) })

          selection.append('text')
            .text(function (d) { return d.name })
            .style('font-weight', 'bold')
            .attr('class', 'roll')
            .attr('text-anchor', 'end')
            .attr('x', function (d) { return x(d.values[0].label) })
            .attr('dx', -10)
            .attr('y', function (d) { return y(d.values[0].y0 + (d.values[0].y / 2) ) + varNames.indexOf(d.name) * 2  })
            .attr('fill', function (d) { return Aspects.getColor(d.name, 300) })

          selection.append('text')
            .text(function (d) { return percent(d.values[0].weight) })
            .attr('class', 'roll')
            .attr('text-anchor', 'end')
            .attr('x', function (d) { return x(d.values[0].label) })
            .attr('dx', -10)
            .attr('y', function (d) { return y(d.values[0].y0 + (d.values[0].y / 2) ) + varNames.indexOf(d.name) * 2 })
            .attr('dy', '1em')

          svg.append('text')
            .text('Well-Being Index')
            .attr('text-anchor', 'end')
            .attr('x', function (d) { return x(seriesArr[0].values[0].label) })
            .attr('y', function (d) { return y(seriesArr[0].values[0].y0 + seriesArr[0].values[0].y ) })
            .attr('dx', -10)
            .attr('dy', -16)
            .style('font-weight', 'bold')
            .style('text-decoration', 'underline')

          var values = selection.append('g')

          data.pop()
          data.shift()

          values.selectAll('text').
            data(function (d) {
              d.values.pop()
              d.values.shift()
              return d.values
            })
            .enter().append('text')
              .attr('class', function (d) {
                return 'value d' + d.label
              })
              .text(function (d) { return d.value })
              .style('font-weight', 'bold')
              .attr('x', function (d) { return x(d.label) })
              .attr('y', function (d) { return y(d.y0 + (d.y / 2)) + varNames.indexOf(d.name) * 2  })
              .attr('dy', '7')
              .attr('text-anchor', 'middle')
              // .attr('text-anchor', function (d) { 
              //   if (d.label === dates[0]) return 'end'
              //   else if (d.label === dates[dates.length - 1]) return 'start'
              //   else return 'middle'
              // })
              // .attr('dx', function (d) {
              //   if (d.label === dates[0]) return -5
              //   else if (d.label === dates[dates.length - 1]) return 5
              //   else return 0             
              // })
              .attr('fill', function (d) { return Aspects.getColor(d.name, 300) })

          var sums = svg.selectAll()
              .data(data)
            .enter().append('g').attr('class', function (d) {
              return 'day d' + d.date
            })

          sums.append('rect')
              .attr('class', function (d) { return 'd' + d.date })
              .attr('x', function (d) { return x(d.date) - 20})
              .attr('y', function (d) {
                var sum = 0
                for (var i in varNames) {
                  sum += d[varNames[i]].value * d[varNames[i]].weight
                }
                return y(sum) - 40
              })
              .attr('width', 40)
              .attr('height', function (d) {
                var sum = 0
                for (var i in varNames) {
                  sum += d[varNames[i]].value * d[varNames[i]].weight
                }
                return height - y(sum)
              })

          sums.append('text')
              .text(function (d) {
                var sum = 0
                for (var i in varNames) {
                  sum += d[varNames[i]].value * d[varNames[i]].weight
                }
                return Math.round(sum)
              })
              .attr('x', function (d) { return x(d.date) })
              .attr('y', function (d) {
                var sum = 0
                for (var i in varNames) {
                  sum += d[varNames[i]].value * d[varNames[i]].weight
                }
                return y(sum)
              })
              .attr('text-anchor', 'middle')
              // .attr('text-anchor', function (d) { 
              //   if (d.date === dates[0]) return 'start'
              //   else if (d.date === dates[dates.length - 1]) return 'end'
              //   else return 'middle'
              // })
              // .attr('dx', function (d) {
              //   if (d.date === dates[0]) return 10
              //   else if (d.date === dates[dates.length - 1]) return -10
              //   else return 0             
              // })
              .attr('dy', '-1.25em')
              .style('font-weight', 'bold')
              .style('text-decoration', 'underline')

          dates.pop()
          dates.shift()

          dates.forEach(function (date) {
            var day = d3.selectAll('.d' + date)
            day.on('mouseover', function () {
              day.classed('highlight', true)
            })
            day.on('mouseout', function () {
              day.classed('highlight', false)
            })
          })

          var xAxis = d3.svg.axis()
            .scale(x)
            .tickValues(dates.map(function (d) {
              return new Date(d)
            }))
            .tickFormat(d3.time.format('%b %d'))
            .orient("bottom")

          var axis = svg.append("g")
              .attr("class", "x axis")
              .attr("transform", "translate(0," + (height - 40) + ")")
              .call(xAxis)
        }

        var labelVar = 'date'
        var data, varNames
        scope.render = function () {
          data = angular.copy(scope.data)
          varNames = d3.keys(data[0])
            .filter(function (key) { return key !== labelVar;})
          if (data.length > 1) {
            multi()
          } else {
            single()
          }
        }
      }
    }
  })
  .directive('pref', function ($window, Aspects, $timeout) {
    return {
      restrict: 'EA',
      scope: {
        degree: '='
      },
      template: 
        '<div class="svg"></div>' +
        '<h5 class="pull-left">I much prefer Option 1</h5>' +
        '<h5 class="pull-right">I much prefer Option 2</h5>',
      link: function(scope, element, attrs) {
        var svg = d3.select(element[0].children[0])
          .append('svg')
          .style('width', '100%')
          .style('padding','12px 20px 16px 20px')

        window.onresize = function() {
          scope.$apply()
        }

        scope.$watch(function() {
          return angular.element($window)[0].innerWidth
        }, function() {
          scope.render()
        })

        var last = null
        scope.$watch('degree', function () {
          if (last !== scope.degree) scope.render()
        })

        scope.render = function () {
          console.log('render')
          svg.selectAll('*').remove()

          var margin = {top: 0, right: 0, bottom: 0, left: 0},
              width = svg.style('width').replace('px','') - svg.style('padding-left').replace('px','') - svg.style('padding-right').replace('px',''),
              height = 10

          var x = d3.scale.linear()
              .domain([1, 10])
              .range([1, width])
              .clamp(true)

          var brush = d3.svg.brush()
              .x(x)
              .on('brush', brushed)

          svg
              .attr('width', width)
              .attr('height', height)
            .append('g')
              .attr('transform', 'translate(' + 50 + ',0)')

          var axis = svg.append('g')
              .attr('class', 'axis')
              .attr('transform', 'translate(0,' + height / 2 + ')')

          axis.call(
            d3.svg.axis()
              .scale(x)
              .orient('bottom')
              .tickSize(0)
              .tickPadding(12)
              .tickValues([])
            )
            .select('.domain')
            .select(function() { return this.parentNode.appendChild(this.cloneNode(true)); })
              .attr('class', 'halo')

          var slider = svg.append('g')
              .attr('class', 'slider')
              .call(brush)

          slider.selectAll('.extent,.resize')
              .remove()

          slider.select('.background')
              .attr('height', height)

          var pointy = function () {
            var cx = x(1)
              cy = height / 2
            return {
              set: function (pt) {
                cx = pt
                return [
                  { x: cx - 6, y: cy - 6 },
                  { x: cx + 6, y: cy - 6 },
                  { x: cx + 6, y: cy + 6 },
                  { x: cx, y: cy + 10 },
                  { x: cx - 6, y: cy + 6 }
                ]
              }

            }
          }

          var line = d3.svg.line()
            .x(function (d) { return d.x })
            .y(function (d) { return d.y })

          var handle = slider.append('path')
              .attr('class', 'handle')
              .attr('transform', 'translate(0,' + Number((height / 2) - 6) + ')')

          function brushed() {
            console.log('brush')
            var value = brush.extent()[0]

            if (d3.event.sourceEvent) { // not a programmatic event
              var v = x.invert(d3.mouse(this)[0])
              value = isNaN(v) ? value : v
              brush.extent([value, value])
            }

            if (value) {
              if (value) value = Math.round(value)
              handle.attr('d', line( pointy().set( x(value) ) ) + 'Z')
              $timeout(function () {
                scope.degree = value
              })
              last = value
              // d3.select(element[0].children[0]).style('background-color', Aspects.mixColor('Health', 'Happiness', value))
            } else if (value === 0) {
              handle.remove()
            }

          }
        }
      }
    }
  })
